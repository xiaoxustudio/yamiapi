<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: file.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: file.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict'

// ******************************** 文件系统 ********************************

const File = new class {
  // 同步加载文件映射表
  syncLoadings = new Map()

  // 加载文件Promise集合
  loadingPromises = {}

  // 加载进度
  loadingProgress = 0

  // 正在引用的二进制对象列表
  referencedBlobs = []

  // 更新数据
  update() {
    if (this.referencedBlobs.length !== 0) {
      for (const blob of this.referencedBlobs) {
        URL.revokeObjectURL(blob.url)
      }
      this.referencedBlobs.length = 0
    }
  }

  // 解密
  async decrypt({path, sync, type}) {
    const buffer = decrypt(await File.xhr({path, sync, type: 'arraybuffer'}))
    switch (type) {
      case 'url': {
        const blob = new Blob([buffer])
        const url = URL.createObjectURL(blob)
        this.referencedBlobs.push(blob)
        return blob.url = url
      }
      case 'text':
        return Codec.textDecoder.decode(buffer)
      case 'json':
        return JSON.parse(Codec.textDecoder.decode(buffer))
      case 'arraybuffer':
        return buffer
    }
  }

  /**
   * 获取文件
   * @param {Object} descriptor 文件描述器
   * @returns {Promise&lt;Object|Image|null>}
   */
  get(descriptor) {
    // 可以指定路径或GUID来加载文件
    const path = descriptor.path ?? this.getPathByGUID(descriptor.guid)
    const sync = descriptor.sync
    const type = descriptor.type
    switch (type) {
      case 'image': {
        const {loadingPromises} = this
        // 如果当前图像已在加载中，则返回Promise，否则新建
        return loadingPromises[path] || (
        loadingPromises[path] = new Promise(async resolve => {
          const image = new Image()
          // 给图像元素设置guid用于纹理的查找
          image.guid = descriptor.guid ?? ''
          let url = path
          let callback
          if (/\.dat$/.test(path)) {
            try {
              url = await this.decrypt({path, sync, type: 'url'})
            } catch (error) {
              delete loadingPromises[path]
              return resolve(null)
            }
          } else if (sync) {
            // 同步加载图像资源
            switch (Stats.isOnClient) {
              case true: {
                // 若是本地模式运行，模拟加载进度
                const progress = {
                  complete: false,
                  lengthComputable: true,
                  loaded: 0,
                  total: 1,
                }
                this.syncLoadings.set(image, progress)
                callback = () => {
                  progress.complete = true
                  progress.loaded = 1
                }
                break
              }
              case false:
                // 若是Web模式运行，先用XHR加载数据块，再解析成图像
                // 这样可以获取加载进度，用来显示进度条
                try {
                  const blob = await File.xhr({path, sync, type: 'blob'})
                  url = blob.url = URL.createObjectURL(blob)
                  this.referencedBlobs.push(blob)
                } catch (error) {
                  delete loadingPromises[path]
                  return resolve(null)
                }
                break
            }
          }
          // 加载图像资源
          image.onload = () => {
            delete loadingPromises[path]
            image.onload = null
            image.onerror = null
            callback?.()
            resolve(image)
          }
          image.onerror = () => {
            delete loadingPromises[path]
            image.onload = null
            image.onerror = null
            image.src = ''
            callback?.()
            resolve(null)
          }
          image.src = url
        }))
      }
      default:
        return /\.dat$/.test(path)
        ? this.decrypt({path, sync, type})
        : this.xhr({path, sync, type})
    }
  }

  /**
   * 使用XHR加载文件
   * @param {Object} $
   * @param {string} $.path 文件路径
   * @param {boolean} $.sync 同步开关
   * @param {string} $.type 类型
   * @returns {Promise}
   */
  xhr({path, sync, type}) {
    return new Promise((resolve, reject) => {
      const request = new XMLHttpRequest()
      if (sync) {
        // 同步加载即时更新进度
        request.onloadstart =
        request.onprogress = event => {
          event.complete = false
          this.syncLoadings.set(request, event)
        }
      }
      request.onload = event => {
        event.complete = true
        this.syncLoadings.set(request, event)
        resolve(request.response)
      }
      request.onerror = event => {
        this.syncLoadings.delete(request)
        reject(request.response)
      }
      request.open('GET', path)
      request.responseType = type
      request.send()
    })
  }

  /** 获取文件路径(客户端专用) */
  route(relativePath) {
    return require('path').resolve(__dirname, relativePath)
  }

  /**
   * 获取文件路径(通过GUID)
   * @param {string} guid 文件GUID
   * @returns {string} 文件路径或空字符串
   */
  getPathByGUID(guid) {
    return Data.manifest.guidMap[guid]?.path ?? ''
  }

  /**
   * 更新同步加载进度
   * @returns {boolean} 加载是否完成
   */
  updateLoadingProgress() {
    // 如果不存在同步加载，则继续
    const {syncLoadings} = this
    if (syncLoadings.size === 0) {
      return false
    }
    // 统计已加载和总的数据字节大小
    let loaded = 0
    let total = 0
    let complete = true
    for (const progress of syncLoadings.values()) {
      if (progress.lengthComputable) {
        loaded += progress.loaded
        total += progress.total
      }
      if (!progress.complete) {
        complete = false
      }
    }
    // 计算加载进度
    this.loadingProgress = loaded / (total || Infinity)
    // 加载进度为100%，不存在未知数据大小，已导入所有字体，则判定为加载完成
    if (complete &amp;&amp; !Printer.importing.length) {
      // 删除同步加载进度表中的所有键值对
      for (const key of syncLoadings.keys()) {
        syncLoadings.delete(key)
      }
      // 移除进度条后继续
      GL.container.progress &amp;&amp;
      GL.container.progress.remove()
      return false
    }
    // 未加载完成
    return true
  }

  /** 渲染同步加载进度 */
  renderLoadingProgress() {
    // 擦除游戏画布内容(显示为黑屏)
    GL.clearColor(0, 0, 0, 0)
    GL.clear(GL.COLOR_BUFFER_BIT)
    // 只有Web模式下才会显示进度条
    if (!Stats.isOnClient) {
      let {progress} = GL.container
      if (!progress) {
        // 创建进度条并设置样式
        progress = document.createElement('div')
        progress.style.position = 'absolute'
        progress.style.left = '0'
        progress.style.bottom = '0'
        progress.style.height = '10px'
        progress.style.backgroundImage = `
        linear-gradient(
          to right,
          white 0%,
          white 33%,
          transparent 33%,
          transparent 100%
        )`
        progress.style.backgroundSize = '3px 1px'
        progress.style.pointerEvents = 'none'
        // 设置移除进度条方法(加载完成时调用)
        progress.remove = () => {
          GL.container.progress = null
          GL.container.removeChild(progress)
        }
        // 添加进度条到容器元素中
        GL.container.progress = progress
        GL.container.appendChild(progress)
      }
      // 更新当前的进度
      const percent = Math.round(this.loadingProgress * 100)
      if (progress.percent !== percent) {
        progress.percent = percent
        progress.style.width = `${percent}%`
      }
    }
  }
}

// ******************************** 全局唯一标识符 ********************************

const GUID = new class {
  // 检查用的正则表达式
  regExpForChecking = /[a-f]/

  /**
   * 生成32位GUID(8个字符)
   * @returns {string}
   */
  generate32bit() {
    const n = Math.random() * 0x100000000
    const s = Math.floor(n).toString(16)
    return s.length === 8 ? s : s.padStart(8, '0')
  }

  /**
   * 生成64位GUID(16个字符)
   * @returns {string}
   */
  generate64bit() {
    let id
    // GUID通常用作哈希表的键
    // 避免纯数字的键(会降低访问速度)
    do {id = this.generate32bit() + this.generate32bit()}
    while (!this.regExpForChecking.test(id))
    return id
  }
}

// ******************************** 提前加载配置文件(减少启动等待事件) ********************************

!function LoadConfig() {
  window.config = File.get({
    path: 'Data/config.json',
    type: 'json',
    sync: true,
  })
}()</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Actor.html">Actor</a></li><li><a href="ActorCollider.html">ActorCollider</a></li><li><a href="ActorNavigator.html">ActorNavigator</a></li><li><a href="Animation.html">Animation</a></li><li><a href="AnimationController.html">AnimationController</a></li><li><a href="AudioPlayer.html">AudioPlayer</a></li><li><a href="AudioReverb.html">AudioReverb</a></li><li><a href="BatchRenderer.html">BatchRenderer</a></li><li><a href="CooldownItem.html">CooldownItem</a></li><li><a href="CooldownManager.html">CooldownManager</a></li><li><a href="DialogBoxElement.html">DialogBoxElement</a></li><li><a href="EasingMap.html">EasingMap</a></li><li><a href="Equipment.html">Equipment</a></li><li><a href="EquipmentManager.html">EquipmentManager</a></li><li><a href="EventHandler.html">EventHandler</a></li><li><a href="ImageElement.html">ImageElement</a></li><li><a href="ImageTexture.html">ImageTexture</a></li><li><a href="Inventory.html">Inventory</a></li><li><a href="Item.html">Item</a></li><li><a href="Matrix.html">Matrix</a></li><li><a href="MultipleAudioPlayer.html">MultipleAudioPlayer</a></li><li><a href="ParticleElement.html">ParticleElement</a></li><li><a href="ParticleEmitter.html">ParticleEmitter</a></li><li><a href="ParticleLayer.html">ParticleLayer</a></li><li><a href="Printer.html">Printer</a></li><li><a href="ProgressBarElement.html">ProgressBarElement</a></li><li><a href="SceneActorList.html">SceneActorList</a></li><li><a href="SceneAnimation.html">SceneAnimation</a></li><li><a href="SceneAnimationList.html">SceneAnimationList</a></li><li><a href="SceneContext.html">SceneContext</a></li><li><a href="SceneGridCellList.html">SceneGridCellList</a></li><li><a href="SceneLight.html">SceneLight</a></li><li><a href="SceneLightManager.html">SceneLightManager</a></li><li><a href="SceneObstacleArray.html">SceneObstacleArray</a></li><li><a href="SceneParallax.html">SceneParallax</a></li><li><a href="SceneParallaxManager.html">SceneParallaxManager</a></li><li><a href="SceneParticleEmitter.html">SceneParticleEmitter</a></li><li><a href="SceneParticleEmitterList.html">SceneParticleEmitterList</a></li><li><a href="SceneRegion.html">SceneRegion</a></li><li><a href="SceneRegionList.html">SceneRegionList</a></li><li><a href="SceneSpriteRenderer.html">SceneSpriteRenderer</a></li><li><a href="SceneTerrainArray.html">SceneTerrainArray</a></li><li><a href="SceneTilemap.html">SceneTilemap</a></li><li><a href="SceneTriggerList.html">SceneTriggerList</a></li><li><a href="Script.html">Script</a></li><li><a href="Shortcut.html">Shortcut</a></li><li><a href="Skill.html">Skill</a></li><li><a href="SkillCooldownList.html">SkillCooldownList</a></li><li><a href="SkillManager.html">SkillManager</a></li><li><a href="State.html">State</a></li><li><a href="StateCountdownList.html">StateCountdownList</a></li><li><a href="StateManager.html">StateManager</a></li><li><a href="TargetManager.html">TargetManager</a></li><li><a href="TextBoxElement.html">TextBoxElement</a></li><li><a href="TextElement.html">TextElement</a></li><li><a href="Texture.html">Texture</a></li><li><a href="TextureManager.html">TextureManager</a></li><li><a href="Timer.html">Timer</a></li><li><a href="Trigger.html">Trigger</a></li><li><a href="UIElement.html">UIElement</a></li><li><a href="VideoElement.html">VideoElement</a></li><li><a href="WindowElement.html">WindowElement</a></li></ul><h3>Global</h3><ul><li><a href="global.html#GL">GL</a></li><li><a href="global.html#_createElement">_createElement</a></li><li><a href="global.html#_updateBubbleState">_updateBubbleState</a></li><li><a href="global.html#activate">activate</a></li><li><a href="global.html#add">add</a></li><li><a href="global.html#addMember">addMember</a></li><li><a href="global.html#addPointerEventRoot">addPointerEventRoot</a></li><li><a href="global.html#append">append</a></li><li><a href="global.html#autorun">autorun</a></li><li><a href="global.html#bind">bind</a></li><li><a href="global.html#buildPath">buildPath</a></li><li><a href="global.html#calculateCoords">calculateCoords</a></li><li><a href="global.html#calculateSceneCoords">calculateSceneCoords</a></li><li><a href="global.html#call">call</a></li><li><a href="global.html#callAutorunEvents">callAutorunEvents</a></li><li><a href="global.html#callSpecialEvent">callSpecialEvent</a></li><li><a href="global.html#changeRelation">changeRelation</a></li><li><a href="global.html#checkIfRemovedHover">checkIfRemovedHover</a></li><li><a href="global.html#clearGlobalActors">clearGlobalActors</a></li><li><a href="global.html#compileEvents">compileEvents</a></li><li><a href="global.html#continue">continue</a></li><li><a href="global.html#convertToScreenCoords">convertToScreenCoords</a></li><li><a href="global.html#create">create</a></li><li><a href="global.html#createAutotileMap">createAutotileMap</a></li><li><a href="global.html#createEasingMap">createEasingMap</a></li><li><a href="global.html#createElement">createElement</a></li><li><a href="global.html#createFollower">createFollower</a></li><li><a href="global.html#createMembers">createMembers</a></li><li><a href="global.html#createPath">createPath</a></li><li><a href="global.html#createPlayer">createPlayer</a></li><li><a href="global.html#createUnitPath">createUnitPath</a></li><li><a href="global.html#decodeClone">decodeClone</a></li><li><a href="global.html#decodeTeamData">decodeTeamData</a></li><li><a href="global.html#decodeTerrains">decodeTerrains</a></li><li><a href="global.html#decodeTiles">decodeTiles</a></li><li><a href="global.html#delete">delete</a></li><li><a href="global.html#deleteGameData">deleteGameData</a></li><li><a href="global.html#disable">disable</a></li><li><a href="global.html#displayErrorMessage">displayErrorMessage</a></li><li><a href="global.html#doubleclick">doubleclick</a></li><li><a href="global.html#emit">emit</a></li><li><a href="global.html#emitInputEvent">emitInputEvent</a></li><li><a href="global.html#enable">enable</a></li><li><a href="global.html#encodeTeamData">encodeTeamData</a></li><li><a href="global.html#encodeTerrains">encodeTerrains</a></li><li><a href="global.html#executeCallbacks">executeCallbacks</a></li><li><a href="global.html#find">find</a></li><li><a href="global.html#follow">follow</a></li><li><a href="global.html#gamepadbuttonpress">gamepadbuttonpress</a></li><li><a href="global.html#gamepadbuttonrelease">gamepadbuttonrelease</a></li><li><a href="global.html#gamepadleftstickchange">gamepadleftstickchange</a></li><li><a href="global.html#gamepadrightstickchange">gamepadrightstickchange</a></li><li><a href="global.html#generate32bit">generate32bit</a></li><li><a href="global.html#generate64bit">generate64bit</a></li><li><a href="global.html#get">get</a></li><li><a href="global.html#getElementAtMouse">getElementAtMouse</a></li><li><a href="global.html#getGroup">getGroup</a></li><li><a href="global.html#getItem">getItem</a></li><li><a href="global.html#getKey">getKey</a></li><li><a href="global.html#getKeys">getKeys</a></li><li><a href="global.html#getName">getName</a></li><li><a href="global.html#getParallaxAnchor">getParallaxAnchor</a></li><li><a href="global.html#getPathByGUID">getPathByGUID</a></li><li><a href="global.html#getPointerEventRoot">getPointerEventRoot</a></li><li><a href="global.html#getRelationByIndexes">getRelationByIndexes</a></li><li><a href="global.html#getValue">getValue</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#isEnemy">isEnemy</a></li><li><a href="global.html#isFriendly">isFriendly</a></li><li><a href="global.html#isMacOS">isMacOS</a></li><li><a href="global.html#keydown">keydown</a></li><li><a href="global.html#keydownFilter">keydownFilter</a></li><li><a href="global.html#keyup">keyup</a></li><li><a href="global.html#load">load</a></li><li><a href="global.html#loadData">loadData</a></li><li><a href="global.html#loadFile">loadFile</a></li><li><a href="global.html#loadGameData">loadGameData</a></li><li><a href="global.html#loadGlobalData">loadGlobalData</a></li><li><a href="global.html#loadMeta">loadMeta</a></li><li><a href="global.html#loadObjects">loadObjects</a></li><li><a href="global.html#loadPresets">loadPresets</a></li><li><a href="global.html#loadSaveMeta">loadSaveMeta</a></li><li><a href="global.html#loadScene">loadScene</a></li><li><a href="global.html#loadScripts">loadScripts</a></li><li><a href="global.html#loadUI">loadUI</a></li><li><a href="global.html#mousedown">mousedown</a></li><li><a href="global.html#mousedownLB">mousedownLB</a></li><li><a href="global.html#mousedownRB">mousedownRB</a></li><li><a href="global.html#mouseleave">mouseleave</a></li><li><a href="global.html#mousemove">mousemove</a></li><li><a href="global.html#mouseup">mouseup</a></li><li><a href="global.html#mouseupLB">mouseupLB</a></li><li><a href="global.html#mouseupRB">mouseupRB</a></li><li><a href="global.html#moveTo">moveTo</a></li><li><a href="global.html#off">off</a></li><li><a href="global.html#on">on</a></li><li><a href="global.html#onTransitionEnd">onTransitionEnd</a></li><li><a href="global.html#open">open</a></li><li><a href="global.html#parseCSSColor">parseCSSColor</a></li><li><a href="global.html#parseDateTimestamp">parseDateTimestamp</a></li><li><a href="global.html#parseFloatArray">parseFloatArray</a></li><li><a href="global.html#parseFloatArrayTag">parseFloatArrayTag</a></li><li><a href="global.html#parseGUID">parseGUID</a></li><li><a href="global.html#parseInt">parseInt</a></li><li><a href="global.html#parseIntArray">parseIntArray</a></li><li><a href="global.html#pause">pause</a></li><li><a href="global.html#pointerdown">pointerdown</a></li><li><a href="global.html#pointerenter">pointerenter</a></li><li><a href="global.html#pointerleave">pointerleave</a></li><li><a href="global.html#pointermove">pointermove</a></li><li><a href="global.html#pointerup">pointerup</a></li><li><a href="global.html#pop">pop</a></li><li><a href="global.html#precompile">precompile</a></li><li><a href="global.html#precompileActors">precompileActors</a></li><li><a href="global.html#precompileAnimations">precompileAnimations</a></li><li><a href="global.html#precompileEquipments">precompileEquipments</a></li><li><a href="global.html#precompileItems">precompileItems</a></li><li><a href="global.html#precompileSkills">precompileSkills</a></li><li><a href="global.html#precompileStates">precompileStates</a></li><li><a href="global.html#precompileTriggers">precompileTriggers</a></li><li><a href="global.html#preventInput">preventInput</a></li><li><a href="global.html#push">push</a></li><li><a href="global.html#remapScripts">remapScripts</a></li><li><a href="global.html#remove">remove</a></li><li><a href="global.html#removeItem">removeItem</a></li><li><a href="global.html#removeLatestPointerEventRoot">removeLatestPointerEventRoot</a></li><li><a href="global.html#removeMember">removeMember</a></li><li><a href="global.html#removePointerEventRoot">removePointerEventRoot</a></li><li><a href="global.html#render">render</a></li><li><a href="global.html#renderLoadingProgress">renderLoadingProgress</a></li><li><a href="global.html#reset">reset</a></li><li><a href="global.html#resetPointerEventRoots">resetPointerEventRoots</a></li><li><a href="global.html#resize">resize</a></li><li><a href="global.html#restoreInput">restoreInput</a></li><li><a href="global.html#rotateAndScaleCanvas">rotateAndScaleCanvas</a></li><li><a href="global.html#route">route</a></li><li><a href="global.html#saveData">saveData</a></li><li><a href="global.html#saveGameData">saveGameData</a></li><li><a href="global.html#saveGlobalData">saveGlobalData</a></li><li><a href="global.html#scaleCanvas">scaleCanvas</a></li><li><a href="global.html#set">set</a></li><li><a href="global.html#setBypass">setBypass</a></li><li><a href="global.html#setItem">setItem</a></li><li><a href="global.html#setPlayer">setPlayer</a></li><li><a href="global.html#setTimeScale">setTimeScale</a></li><li><a href="global.html#setToHighestPriority">setToHighestPriority</a></li><li><a href="global.html#setZoomFactor">setZoomFactor</a></li><li><a href="global.html#shake">shake</a></li><li><a href="global.html#shareInventory">shareInventory</a></li><li><a href="global.html#simulateKey">simulateKey</a></li><li><a href="global.html#start">start</a></li><li><a href="global.html#stop">stop</a></li><li><a href="global.html#switchGameInfoDisplay">switchGameInfoDisplay</a></li><li><a href="global.html#testConditions">testConditions</a></li><li><a href="global.html#unfollow">unfollow</a></li><li><a href="global.html#unpack">unpack</a></li><li><a href="global.html#unpackTeamData">unpackTeamData</a></li><li><a href="global.html#update">update</a></li><li><a href="global.html#updateLoadingProgress">updateLoadingProgress</a></li><li><a href="global.html#wheel">wheel</a></li><li><a href="global.html#xhr">xhr</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Mon Aug 21 2023 21:54:29 GMT+0800 (中国标准时间)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
